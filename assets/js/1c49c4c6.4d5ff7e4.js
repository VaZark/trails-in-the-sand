"use strict";(self.webpackChunktil_remaster=self.webpackChunktil_remaster||[]).push([[9031],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return c}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),d=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=d(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},g=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),g=d(n),c=r,u=g["".concat(s,".").concat(c)]||g[c]||m[c]||o;return n?a.createElement(u,i(i({ref:t},p),{},{components:n})):a.createElement(u,i({ref:t},p))}));function c(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=g;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var d=2;d<o;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}g.displayName="MDXCreateElement"},7520:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return d},toc:function(){return p},default:function(){return g}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],l={},s="Model migration across apps",d={unversionedId:"django/db/Migrating model across apps",id:"django/db/Migrating model across apps",title:"Model migration across apps",description:"What and Why",source:"@site/docs-python/django/db/Migrating model across apps.md",sourceDirName:"django/db",slug:"/django/db/Migrating model across apps",permalink:"/docs-python/django/db/Migrating model across apps",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Managers",permalink:"/docs-python/django/db/Managers"},next:{title:"Onboarding existing tables",permalink:"/docs-python/django/db/Onboarding existing tables"}},p=[{value:"What and Why",id:"what-and-why",children:[],level:2},{value:"The breakdown",id:"the-breakdown",children:[{value:"Prepping the new model",id:"prepping-the-new-model",children:[],level:3},{value:"Updating migrations",id:"updating-migrations",children:[],level:3}],level:2},{value:"Dealing with Foreign Keys",id:"dealing-with-foreign-keys",children:[],level:2}],m={toc:p};function g(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},m,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"model-migration-across-apps"},"Model migration across apps"),(0,o.kt)("h2",{id:"what-and-why"},"What and Why"),(0,o.kt)("p",null,"Sometimes as a part of a code refactor or to enable packaging some logic into reusable packages, we might have to move some Django models between apps."),(0,o.kt)("p",null,"This is essentially a minor process when the data is relatively smaller and manageable, ",(0,o.kt)("em",{parentName:"p"},"when not using an ORM"),". Django's ORM as like many of it's counterparts maintains an additiional reference model to keep track of relations, references and the state of the application's schema."),(0,o.kt)("p",null,"So, this will be a simple but tricky process. The simplest solution is to ensure that the new model created points to the old table. This also involves renaming the database table involved. "),(0,o.kt)("blockquote",null,(0,o.kt)("p",{parentName:"blockquote"},"If the migration histories are clean and few, update the older migrations to create only the new model and squash / delete these migrations once your done.")),(0,o.kt)("h2",{id:"the-breakdown"},"The breakdown"),(0,o.kt)("p",null,"Things you need to understand"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"migrations.SeparateDatabaseAndState")," : Allows different actions are run on the Django model and on the DB for same migration"),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("inlineCode",{parentName:"li"},"migrations.AlterModelTable")," : Allows to rename a model's table name")),(0,o.kt)("h3",{id:"prepping-the-new-model"},"Prepping the new model"),(0,o.kt)("ol",null,(0,o.kt)("li",{parentName:"ol"},"Create the new model",(0,o.kt)("ul",{parentName:"li"},(0,o.kt)("li",{parentName:"ul"},"Identify the name of the new model to be created with ",(0,o.kt)("inlineCode",{parentName:"li"},"sqlmigrate")," (generates the SQL query to be executed)"))),(0,o.kt)("li",{parentName:"ol"},"Delete the old model"),(0,o.kt)("li",{parentName:"ol"},"Update all references to the old model")),(0,o.kt)("h3",{id:"updating-migrations"},"Updating migrations"),(0,o.kt)("p",null,"Generate the migrations for the operation"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"In the migration deleting the old model"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-python"},"operations = [\n        # migrations.DeleteModel(\n        #     name='TargetModel',\n        # ),\n        migrations.SeparateDatabaseAndState(\n            state_operations=[\n                migrations.DeleteModel(\n                    name='TargetModel',\n                ),\n            ],\n            database_operations=[\n                migrations.AlterModelTable(\n                    name='TargetModel',\n                    table='newApp_targetModel', # Identified with sqlmigrate\n                ),\n            ],\n        )]\n"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"In the migration creating the new model"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-python"},"operations = [\n    # migrations.CreateModel(\n    #     name='Product',\n    #     fields=[\n    #         ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n    #     ],\n    migrations.SeparateDatabaseAndState(\n        state_operations=[\n            migrations.CreateModel(\n                name='TargetModel',\n                fields=[\n                    ('id', models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),\n                ],\n            ),\n        ],\n        # Table already exists. \n        database_operations=[],\n    )]\n")))),(0,o.kt)("h2",{id:"dealing-with-foreign-keys"},"Dealing with Foreign Keys"),(0,o.kt)("p",null,"Any model migration that has foreign keys essentially, deletes the old keys and recreates it again. However, since we are merely renaming the table, make sure that any additional migrations that deal with foreign keys do not modify the existing relationship. Once agains, we are aided by the ",(0,o.kt)("inlineCode",{parentName:"p"},"SeparateDatabaseAndState")," function."),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"FK in Target Model"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-python"},"    operations = [\n        # migrations.RemoveField(\n        #     model_name='TargetModel',\n        #     name='fk_name',\n        migrations.SeparateDatabaseAndState(\n            state_operations=[\n                migrations.RemoveField(\n                    model_name='TargetModel',\n                    name='fk_name',\n                ),\n            ],\n            database_operations=[],\n        )]\n"))),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("p",{parentName:"li"},"FK to Target Model"),(0,o.kt)("pre",{parentName:"li"},(0,o.kt)("code",{parentName:"pre",className:"language-python"},"    operations = [\n        # migrations.AlterField(\n        #     model_name='otherModel',\n        #     name='fk_to_target',\n        #     field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='newApp.TargetModel'),\n        # ),\n        migrations.SeparateDatabaseAndState(\n            state_operations=[\n                migrations.AlterField(\n                model_name='OtherModel',\n                    name='fk_to_target',\n                    field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='newApp.TargetModel'),\n                ),\n            ],\n            # You're reusing an existing table, so do nothing\n            database_operations=[],\n        )]\n")))))}g.isMDXComponent=!0}}]);